# üîÑ API Migration Plan - HniDashOps

## üìã T·ªïng Quan Migration

**Backend m·ªõi**: `https://localhost:64706/swagger`  
**Frontend hi·ªán t·∫°i**: Nuxt.js v·ªõi Supabase API  
**M·ª•c ti√™u**: Thay th·∫ø ho√†n to√†n API c≈© b·∫±ng .NET Core 9 Backend

---

## üîç Ph√¢n T√≠ch API Hi·ªán T·∫°i

### **1. üìä API Endpoints ƒêang S·ª≠ D·ª•ng**

#### **Authentication Flow (Gi·ªØ nguy√™n + Backend validation):**
```yaml
Current Flow:
  1. Username/Password ho·∫∑c SSO ‚Üí Supabase/Mock validation
  2. L∆∞u user v√†o localStorage
  
New Flow:
  1. Username/Password ho·∫∑c SSO ‚Üí Supabase/Mock validation (GI·ªÆ NGUY√äN)
  2. Sau khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng ‚Üí G·ªçi backend ƒë·ªÉ l·∫•y token
  3. L∆∞u user + backend token v√†o localStorage

Backend Endpoints:
  POST   https://localhost:64706/api/auth/validate    # Validate user v√† tr·∫£ v·ªÅ token
  POST   https://localhost:64706/api/auth/refresh     # Refresh token
  POST   https://localhost:64706/api/auth/logout      # Logout v√† invalidate token
```

#### **Menu Management APIs:**
```yaml
Current (Supabase):
  GET    /api/menus           # L·∫•y danh s√°ch menu
  POST   /api/menus           # T·∫°o menu m·ªõi  
  GET    /api/menus/[id]      # L·∫•y menu theo ID
  PUT    /api/menus/[id]      # C·∫≠p nh·∫≠t menu
  DELETE /api/menus/[id]      # X√≥a menu

New (.NET Core + Bearer Token):
  GET    https://localhost:64706/api/menus            # + Authorization: Bearer {token}
  POST   https://localhost:64706/api/menus            # + Authorization: Bearer {token}
  GET    https://localhost:64706/api/menus/{id}       # + Authorization: Bearer {token}
  PUT    https://localhost:64706/api/menus/{id}       # + Authorization: Bearer {token}
  DELETE https://localhost:64706/api/menus/{id}       # + Authorization: Bearer {token}
```

#### **System Notifications APIs:**
```yaml
Current (Supabase):
  GET    /api/system-notifications           # L·∫•y danh s√°ch th√¥ng b√°o
  POST   /api/system-notifications           # T·∫°o th√¥ng b√°o m·ªõi
  GET    /api/system-notifications/[id]      # L·∫•y th√¥ng b√°o theo ID
  PUT    /api/system-notifications/[id]      # C·∫≠p nh·∫≠t th√¥ng b√°o
  DELETE /api/system-notifications/[id]      # X√≥a th√¥ng b√°o

New (.NET Core + Bearer Token):
  GET    https://localhost:64706/api/system-notifications            # + Authorization: Bearer {token}
  POST   https://localhost:64706/api/system-notifications            # + Authorization: Bearer {token}
  GET    https://localhost:64706/api/system-notifications/{id}       # + Authorization: Bearer {token}
  PUT    https://localhost:64706/api/system-notifications/{id}       # + Authorization: Bearer {token}
  DELETE https://localhost:64706/api/system-notifications/{id}       # + Authorization: Bearer {token}
```

#### **User Management APIs:**
```yaml
Current (Mock):
  GET    /api/users           # L·∫•y danh s√°ch users
  POST   /api/users           # T·∫°o user m·ªõi
  GET    /api/users/[id]      # L·∫•y user theo ID
  PUT    /api/users/[id]      # C·∫≠p nh·∫≠t user
  DELETE /api/users/[id]      # X√≥a user

New (.NET Core + Bearer Token):
  GET    https://localhost:64706/api/users            # + Authorization: Bearer {token}
  POST   https://localhost:64706/api/users            # + Authorization: Bearer {token}
  GET    https://localhost:64706/api/users/{id}       # + Authorization: Bearer {token}
  PUT    https://localhost:64706/api/users/{id}       # + Authorization: Bearer {token}
  DELETE https://localhost:64706/api/users/{id}       # + Authorization: Bearer {token}
```

### **2. üìÅ Files C·∫ßn C·∫≠p Nh·∫≠t**

#### **Composables:**
```yaml
‚úÖ useAuth.ts                 # Authentication logic
‚úÖ useMenus.ts               # Menu management
‚úÖ useSystemNotifications.ts # System notifications
‚úÖ useUsers.ts               # User management
‚úÖ useDepartments.ts         # Department management
‚úÖ useCategories.ts          # Category management
```

#### **Server API Routes:**
```yaml
‚úÖ server/api/menus/index.get.ts
‚úÖ server/api/menus/[id].get.ts
‚úÖ server/api/menus/[id].put.ts
‚úÖ server/api/menus/[id].delete.ts
‚úÖ server/api/menus/index.post.ts
```

#### **Pages:**
```yaml
‚úÖ pages/admin/menus.vue      # Menu management page
‚úÖ pages/admin/users.vue      # User management page
‚úÖ pages/main/dashboard.vue   # Dashboard
```

---

## üöÄ K·∫ø Ho·∫°ch Migration

### **Phase 1: C·∫•u H√¨nh Environment (1 ng√†y)**

#### **Step 1: T·∫°o Environment Variables**
```env
# .env
BACKEND_API_URL=https://localhost:64706
BACKEND_API_TIMEOUT=30000
```

#### **Step 2: C·∫≠p nh·∫≠t nuxt.config.ts**
```typescript
export default defineNuxtConfig({
  runtimeConfig: {
    public: {
      backendApiUrl: process.env.BACKEND_API_URL || 'https://localhost:64706'
    }
  }
})
```

#### **Step 3: T·∫°o API Client**
```typescript
// composables/useApiClient.ts
export const useApiClient = () => {
  const config = useRuntimeConfig()
  const baseURL = config.public.backendApiUrl
  
  const apiClient = $fetch.create({
    baseURL,
    timeout: 30000,
    headers: {
      'Content-Type': 'application/json'
    }
  })
  
  return { apiClient }
}
```

### **Phase 2: Migration Authentication (1 ng√†y)**

#### **Step 1: C·∫≠p nh·∫≠t useAuth.ts - Gi·ªØ nguy√™n flow hi·ªán t·∫°i**
```typescript
// composables/useAuth.ts
export const useAuth = () => {
  const { apiClient } = useApiClient()
  
  // Gi·ªØ nguy√™n flow login hi·ªán t·∫°i (username/password ho·∫∑c SSO)
  const login = async (username: string, password: string) => {
    // 1. X√°c th·ª±c v·ªõi h·ªá th·ªëng hi·ªán t·∫°i (Supabase ho·∫∑c SSO)
    const response = await $fetch('/api/auth/login', {
      method: 'POST',
      body: { username, password }
    })
    
    if (response.success && response.user) {
      // 2. Sau khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng, g·ªçi backend ƒë·ªÉ l·∫•y token
      const backendResponse = await apiClient('/api/auth/validate', {
        method: 'POST',
        body: { 
          user: response.user,
          authType: 'username' // ho·∫∑c 'sso'
        }
      })
      
      if (backendResponse.success) {
        // 3. L∆∞u user + backend token
        const userWithToken = {
          ...response.user,
          backendToken: backendResponse.data.token,
          tokenExpiry: backendResponse.data.expiry
        }
        
        user.value = userWithToken
        if (process.client) {
          localStorage.setItem('auth_user', JSON.stringify(userWithToken))
        }
        return true
      }
    }
    return false
  }
  
  // ... other methods
}
```

#### **Step 2: C·∫≠p nh·∫≠t useSSO.ts - Th√™m backend validation**
```typescript
// composables/useSSO.ts
export const useSSO = () => {
  const { apiClient } = useApiClient()
  
  // Gi·ªØ nguy√™n flow SSO hi·ªán t·∫°i
  const validateSSOToken = async (tokenkey: string) => {
    // 1. Validate v·ªõi SSO server (gi·ªØ nguy√™n)
    const ssoResult = await validateSSOTokenOriginal(tokenkey)
    
    if (ssoResult.success && ssoResult.user) {
      // 2. Sau khi SSO th√†nh c√¥ng, g·ªçi backend ƒë·ªÉ l·∫•y token
      const backendResponse = await apiClient('/api/auth/validate', {
        method: 'POST',
        body: { 
          user: ssoResult.user,
          authType: 'sso',
          ssoToken: tokenkey
        }
      })
      
      if (backendResponse.success) {
        // 3. L∆∞u user + backend token
        const userWithToken = {
          ...ssoResult.user,
          backendToken: backendResponse.data.token,
          tokenExpiry: backendResponse.data.expiry,
          ssoTokenKey: tokenkey
        }
        
        return {
          ...ssoResult,
          user: userWithToken
        }
      }
    }
    
    return ssoResult
  }
  
  // ... other methods
}
```

#### **Step 3: Test Authentication Flow**
```bash
# Test username/password flow
curl -X POST https://localhost:64706/api/auth/validate \
  -H "Content-Type: application/json" \
  -d '{"user":{"id":1,"username":"admin"},"authType":"username"}'

# Test SSO flow  
curl -X POST https://localhost:64706/api/auth/validate \
  -H "Content-Type: application/json" \
  -d '{"user":{"id":1,"username":"khuongnv"},"authType":"sso","ssoToken":"test-token"}'
```

### **Phase 3: Migration Menu APIs (1 ng√†y)**

#### **Step 1: C·∫≠p nh·∫≠t useMenus.ts - S·ª≠ d·ª•ng backend token**
```typescript
// composables/useMenus.ts
export const useMenus = () => {
  const { apiClient } = useApiClient()
  const { getCurrentUser } = useAuth()
  
  // Helper function ƒë·ªÉ l·∫•y backend token
  const getBackendToken = () => {
    const user = getCurrentUser()
    return user?.backendToken || null
  }
  
  const getMenus = async () => {
    const token = getBackendToken()
    if (!token) {
      throw new Error('Backend token not found. Please login again.')
    }
    
    const response = await apiClient('/api/menus', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    return response.data || []
  }
  
  const createMenu = async (menuData: any) => {
    const token = getBackendToken()
    if (!token) {
      throw new Error('Backend token not found. Please login again.')
    }
    
    const response = await apiClient('/api/menus', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      },
      body: menuData
    })
    return response.data
  }
  
  // ... other methods v·ªõi token
}
```

#### **Step 2: C·∫≠p nh·∫≠t Menu Management Page**
```vue
<!-- pages/admin/menus.vue -->
<script setup>
const { getMenus, createMenu, updateMenu, deleteMenu } = useMenus()

// Load menus from new API
const loadMenus = async () => {
  try {
    menus.value = await getMenus()
  } catch (error) {
    console.error('Error loading menus:', error)
  }
}
</script>
```

### **Phase 4: Migration System Notifications (1 ng√†y)**

#### **Step 1: C·∫≠p nh·∫≠t useSystemNotifications.ts - S·ª≠ d·ª•ng backend token**
```typescript
// composables/useSystemNotifications.ts
export const useSystemNotifications = () => {
  const { apiClient } = useApiClient()
  const { getCurrentUser } = useAuth()
  
  // Helper function ƒë·ªÉ l·∫•y backend token
  const getBackendToken = () => {
    const user = getCurrentUser()
    return user?.backendToken || null
  }
  
  const getNotifications = async () => {
    const token = getBackendToken()
    if (!token) {
      throw new Error('Backend token not found. Please login again.')
    }
    
    const response = await apiClient('/api/system-notifications', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    return response.data || []
  }
  
  const createNotification = async (notificationData: any) => {
    const token = getBackendToken()
    if (!token) {
      throw new Error('Backend token not found. Please login again.')
    }
    
    const response = await apiClient('/api/system-notifications', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      },
      body: notificationData
    })
    return response.data
  }
  
  // ... other methods v·ªõi token
}
```

### **Phase 5: Migration User Management (1 ng√†y)**

#### **Step 1: C·∫≠p nh·∫≠t useUsers.ts - S·ª≠ d·ª•ng backend token**
```typescript
// composables/useUsers.ts
export const useUsers = () => {
  const { apiClient } = useApiClient()
  const { getCurrentUser } = useAuth()
  
  // Helper function ƒë·ªÉ l·∫•y backend token
  const getBackendToken = () => {
    const user = getCurrentUser()
    return user?.backendToken || null
  }
  
  const getUsers = async () => {
    const token = getBackendToken()
    if (!token) {
      throw new Error('Backend token not found. Please login again.')
    }
    
    const response = await apiClient('/api/users', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    return response.data || []
  }
  
  const createUser = async (userData: any) => {
    const token = getBackendToken()
    if (!token) {
      throw new Error('Backend token not found. Please login again.')
    }
    
    const response = await apiClient('/api/users', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      },
      body: userData
    })
    return response.data
  }
  
  // ... other methods v·ªõi token
}
```

### **Phase 6: Testing & Validation (2 ng√†y)**

#### **Step 1: Unit Testing**
```typescript
// tests/api.test.ts
describe('API Migration', () => {
  test('Menu API endpoints', async () => {
    const { getMenus } = useMenus()
    const menus = await getMenus()
    expect(menus).toBeDefined()
  })
  
  test('Authentication API', async () => {
    const { login } = useAuth()
    const result = await login('admin', 'admin123')
    expect(result).toBe(true)
  })
})
```

#### **Step 2: Integration Testing**
```bash
# Test all endpoints
npm run test:api
npm run test:integration
```

#### **Step 3: E2E Testing**
```bash
# Test complete user flows
npm run test:e2e
```

---

## üîß Implementation Steps

### **Step 1: Backup Current Implementation**
```bash
# T·∫°o backup branch
git checkout -b backup-before-migration
git add .
git commit -m "Backup before API migration"
git push origin backup-before-migration

# Quay v·ªÅ main branch
git checkout main
```

### **Step 2: T·∫°o Migration Branch**
```bash
# T·∫°o migration branch
git checkout -b feature/api-migration
```

### **Step 3: C·∫≠p nh·∫≠t Environment**
```bash
# Th√™m environment variables
echo "BACKEND_API_URL=https://localhost:64706" >> .env
echo "BACKEND_API_TIMEOUT=30000" >> .env
```

### **Step 4: C·∫≠p nh·∫≠t API Client**
```typescript
// T·∫°o file composables/useApiClient.ts
// Copy n·ªôi dung t·ª´ Phase 1
```

### **Step 5: Migration t·ª´ng Module**
```bash
# Migration theo th·ª© t·ª±:
# 1. Authentication
# 2. Menu Management  
# 3. System Notifications
# 4. User Management
# 5. Departments & Categories
```

### **Step 6: Testing**
```bash
# Test t·ª´ng module
npm run test:auth
npm run test:menus
npm run test:notifications
npm run test:users
```

### **Step 7: Deploy & Monitor**
```bash
# Deploy l√™n staging
npm run build
npm run preview

# Test tr√™n staging
# Deploy l√™n production
```

---

## üìä Migration Checklist

### **Pre-Migration:**
```yaml
‚úÖ Backup current implementation
‚úÖ Create migration branch
‚úÖ Setup environment variables
‚úÖ Create API client
‚úÖ Test backend endpoints
```

### **Migration:**
```yaml
‚úÖ Migrate Authentication APIs
‚úÖ Migrate Menu Management APIs
‚úÖ Migrate System Notifications APIs
‚úÖ Migrate User Management APIs
‚úÖ Migrate Departments & Categories APIs
```

### **Post-Migration:**
```yaml
‚úÖ Unit testing
‚úÖ Integration testing
‚úÖ E2E testing
‚úÖ Performance testing
‚úÖ Security testing
‚úÖ Deploy to staging
‚úÖ Deploy to production
‚úÖ Monitor & fix issues
```

---

## üö® Risk Management

### **High Risk:**
```yaml
‚ö†Ô∏è Authentication flow changes
‚ö†Ô∏è Data format differences
‚ö†Ô∏è Error handling changes
‚ö†Ô∏è Performance impact
```

### **Medium Risk:**
```yaml
‚ö†Ô∏è API response format changes
‚ö†Ô∏è Caching strategy changes
‚ö†Ô∏è Real-time features
```

### **Low Risk:**
```yaml
‚ö†Ô∏è UI component updates
‚ö†Ô∏è Styling changes
‚ö†Ô∏è Documentation updates
```

---

## üìà Success Metrics

### **Technical Metrics:**
```yaml
‚úÖ API response time < 500ms
‚úÖ Error rate < 1%
‚úÖ Uptime > 99.9%
‚úÖ Test coverage > 80%
```

### **Business Metrics:**
```yaml
‚úÖ User login success rate > 95%
‚úÖ Menu loading time < 2s
‚úÖ Notification delivery rate > 98%
‚úÖ User satisfaction > 4.5/5
```

---

## üéØ Timeline

```yaml
Day 1: Environment setup + Authentication flow (gi·ªØ nguy√™n + backend validation)
Day 2: Menu Management migration (v·ªõi Bearer token)
Day 3: System Notifications migration (v·ªõi Bearer token)
Day 4: User Management migration (v·ªõi Bearer token)
Day 5: Testing & validation
Day 6: Deploy & monitor
```

**Total: 6 ng√†y**

## üîë Key Changes Summary

### **Authentication Flow:**
```yaml
‚úÖ Gi·ªØ nguy√™n: Username/Password v√† SSO login
‚úÖ Th√™m m·ªõi: Backend token validation sau khi ƒëƒÉng nh·∫≠p
‚úÖ L∆∞u tr·ªØ: User + Backend token trong localStorage
‚úÖ S·ª≠ d·ª•ng: Bearer token cho t·∫•t c·∫£ API calls
```

### **API Calls:**
```yaml
‚úÖ T·∫•t c·∫£ API calls ƒë·ªÅu c√≥ Authorization header
‚úÖ Token ƒë∆∞·ª£c l·∫•y t·ª´ user session
‚úÖ Auto-refresh token khi c·∫ßn thi·∫øt
‚úÖ Error handling khi token h·∫øt h·∫°n
```

---

## üîÑ Rollback Plan

### **N·∫øu c√≥ v·∫•n ƒë·ªÅ:**
```bash
# Rollback v·ªÅ backup branch
git checkout backup-before-migration
git push origin main --force

# Ho·∫∑c rollback t·ª´ng module
git checkout backup-before-migration -- composables/useAuth.ts
git checkout backup-before-migration -- composables/useMenus.ts
```

---

*K·∫ø ho·∫°ch migration n√†y ƒë·∫£m b·∫£o chuy·ªÉn ƒë·ªïi an to√†n t·ª´ Supabase API sang .NET Core 9 Backend v·ªõi minimal downtime v√† risk.*
